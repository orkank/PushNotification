<?xml version="1.0"?>
<schema xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance"
        xsi:noNamespaceSchemaLocation="urn:magento:framework:Setup/Declaration/Schema/etc/schema.xsd">
    <table name="idangerous_push_notification_tokens" resource="default" engine="innodb" comment="Push Notification Tokens" charset="utf8mb4" collation="utf8mb4_unicode_ci">
        <column xsi:type="int" name="entity_id" unsigned="true" nullable="false" identity="true" comment="Entity ID"/>
        <column xsi:type="varchar" name="token" nullable="false" length="255" comment="APN/FCM Token"/>
        <column xsi:type="varchar" name="device_type" nullable="false" length="20" comment="Device Type (ios/android)"/>
        <column xsi:type="varchar" name="device_id" nullable="true" length="255" comment="Device ID"/>
        <column xsi:type="varchar" name="device_model" nullable="true" length="255" comment="Device Model"/>
        <column xsi:type="varchar" name="os_version" nullable="true" length="50" comment="OS Version"/>
        <column xsi:type="varchar" name="app_version" nullable="true" length="50" comment="App Version"/>
        <column xsi:type="int" name="customer_id" unsigned="true" nullable="true" comment="Customer ID"/>
        <column xsi:type="varchar" name="customer_email" nullable="true" length="255" comment="Customer Email"/>
        <column xsi:type="smallint" name="store_id" unsigned="true" nullable="false" default="0" comment="Store ID"/>
        <column xsi:type="boolean" name="is_active" nullable="false" default="true" comment="Is Active"/>
        <column xsi:type="timestamp" name="created_at" nullable="false" default="CURRENT_TIMESTAMP" comment="Created At"/>
        <column xsi:type="timestamp" name="updated_at" nullable="false" default="CURRENT_TIMESTAMP" on_update="true" comment="Updated At"/>
        <column xsi:type="timestamp" name="last_seen_at" nullable="false" default="CURRENT_TIMESTAMP" comment="Last Seen At"/>

        <constraint xsi:type="primary" referenceId="PRIMARY">
            <column name="entity_id"/>
        </constraint>
        <constraint xsi:type="unique" referenceId="IDANGEROUS_PUSH_NOTIFICATION_TOKENS_TOKEN">
            <column name="token"/>
        </constraint>
        <constraint xsi:type="foreign" referenceId="IDANGEROUS_PUSH_NOTIFICATION_TOKENS_CUSTOMER_ID_CUSTOMER_ENTITY_ENTITY_ID"
                    table="idangerous_push_notification_tokens" column="customer_id"
                    referenceTable="customer_entity" referenceColumn="entity_id" onDelete="SET NULL"/>
        <constraint xsi:type="foreign" referenceId="IDANGEROUS_PUSH_NOTIFICATION_TOKENS_STORE_ID_STORE_STORE_ID"
                    table="idangerous_push_notification_tokens" column="store_id"
                    referenceTable="store" referenceColumn="store_id" onDelete="CASCADE"/>
        <index referenceId="IDANGEROUS_PUSH_NOTIFICATION_TOKENS_CUSTOMER_ID" indexType="btree">
            <column name="customer_id"/>
        </index>
        <index referenceId="IDANGEROUS_PUSH_NOTIFICATION_TOKENS_DEVICE_TYPE" indexType="btree">
            <column name="device_type"/>
        </index>
        <index referenceId="IDANGEROUS_PUSH_NOTIFICATION_TOKENS_IS_ACTIVE" indexType="btree">
            <column name="is_active"/>
        </index>
    </table>

    <table name="idangerous_push_notification_logs" resource="default" engine="innodb" comment="Push Notification Logs" charset="utf8mb4" collation="utf8mb4_unicode_ci">
        <column xsi:type="int" name="entity_id" unsigned="true" nullable="false" identity="true" comment="Entity ID"/>
        <column xsi:type="varchar" name="title" nullable="false" length="255" comment="Notification Title"/>
        <column xsi:type="text" name="message" nullable="false" comment="Notification Message"/>
        <column xsi:type="varchar" name="image_url" nullable="true" length="500" comment="Image URL"/>
        <column xsi:type="varchar" name="action_url" nullable="true" length="500" comment="Action URL"/>
        <column xsi:type="text" name="custom_data" nullable="true" comment="Custom JSON Data"/>
        <column xsi:type="varchar" name="notification_type" nullable="false" length="50" default="general" comment="Notification Type"/>
        <column xsi:type="int" name="customer_id" unsigned="true" nullable="true" comment="Customer ID (for single user)"/>
        <column xsi:type="text" name="filters" nullable="true" comment="Filters applied (JSON)"/>
        <column xsi:type="int" name="total_sent" unsigned="true" nullable="false" default="0" comment="Total Sent"/>
        <column xsi:type="int" name="total_failed" unsigned="true" nullable="false" default="0" comment="Total Failed"/>
        <column xsi:type="varchar" name="status" nullable="false" length="20" default="pending" comment="Status"/>
        <column xsi:type="text" name="error_message" nullable="true" comment="Error Message"/>
        <column xsi:type="smallint" name="store_id" unsigned="true" nullable="false" default="0" comment="Store ID"/>
        <column xsi:type="varchar" name="content_hash" nullable="true" length="64" comment="Content Hash for Duplicate Detection"/>
        <column xsi:type="timestamp" name="scheduled_at" nullable="true" comment="Scheduled Send Time"/>
        <column xsi:type="timestamp" name="created_at" nullable="false" default="CURRENT_TIMESTAMP" comment="Created At"/>
        <column xsi:type="timestamp" name="processed_at" nullable="true" comment="Processed At"/>

        <constraint xsi:type="primary" referenceId="PRIMARY">
            <column name="entity_id"/>
        </constraint>
        <constraint xsi:type="foreign" referenceId="IDANGEROUS_PUSH_NOTIFICATION_LOGS_CUSTOMER_ID_CUSTOMER_ENTITY_ENTITY_ID"
                    table="idangerous_push_notification_logs" column="customer_id"
                    referenceTable="customer_entity" referenceColumn="entity_id" onDelete="SET NULL"/>
        <constraint xsi:type="foreign" referenceId="IDANGEROUS_PUSH_NOTIFICATION_LOGS_STORE_ID_STORE_STORE_ID"
                    table="idangerous_push_notification_logs" column="store_id"
                    referenceTable="store" referenceColumn="store_id" onDelete="CASCADE"/>
        <index referenceId="IDANGEROUS_PUSH_NOTIFICATION_LOGS_STATUS" indexType="btree">
            <column name="status"/>
        </index>
        <index referenceId="IDANGEROUS_PUSH_NOTIFICATION_LOGS_CREATED_AT" indexType="btree">
            <column name="created_at"/>
        </index>
        <index referenceId="IDANGEROUS_PUSH_NOTIFICATION_LOGS_CONTENT_HASH" indexType="btree">
            <column name="content_hash"/>
        </index>
        <index referenceId="IDANGEROUS_PUSH_NOTIFICATION_LOGS_SCHEDULED_AT" indexType="btree">
            <column name="scheduled_at"/>
        </index>
    </table>

    <table name="idangerous_push_notification_sent" resource="default" engine="innodb" comment="Push Notification Sent Tracking (Temporary - Auto Cleanup)" charset="utf8mb4" collation="utf8mb4_unicode_ci">
        <column xsi:type="int" name="entity_id" unsigned="true" nullable="false" identity="true" comment="Entity ID"/>
        <column xsi:type="int" name="notification_log_id" unsigned="true" nullable="false" comment="Notification Log ID"/>
        <column xsi:type="int" name="token_id" unsigned="true" nullable="false" comment="Token ID"/>
        <column xsi:type="timestamp" name="sent_at" nullable="false" default="CURRENT_TIMESTAMP" comment="Sent At"/>

        <constraint xsi:type="primary" referenceId="PRIMARY">
            <column name="entity_id"/>
        </constraint>
        <constraint xsi:type="unique" referenceId="IDANGEROUS_PUSH_NOTIFICATION_SENT_UNIQUE_LOG_TOKEN">
            <column name="notification_log_id"/>
            <column name="token_id"/>
        </constraint>
        <constraint xsi:type="foreign" referenceId="IDANGEROUS_PUSH_NOTIFICATION_SENT_LOG_ID"
                    table="idangerous_push_notification_sent" column="notification_log_id"
                    referenceTable="idangerous_push_notification_logs" referenceColumn="entity_id"
                    onDelete="CASCADE"/>
        <constraint xsi:type="foreign" referenceId="IDANGEROUS_PUSH_NOTIFICATION_SENT_TOKEN_ID"
                    table="idangerous_push_notification_sent" column="token_id"
                    referenceTable="idangerous_push_notification_tokens" referenceColumn="entity_id"
                    onDelete="CASCADE"/>
        <index referenceId="IDANGEROUS_PUSH_NOTIFICATION_SENT_NOTIFICATION_LOG" indexType="btree">
            <column name="notification_log_id"/>
        </index>
        <index referenceId="IDANGEROUS_PUSH_NOTIFICATION_SENT_TOKEN" indexType="btree">
            <column name="token_id"/>
        </index>
        <index referenceId="IDANGEROUS_PUSH_NOTIFICATION_SENT_SENT_AT" indexType="btree">
            <column name="sent_at"/>
        </index>
    </table>
</schema>

